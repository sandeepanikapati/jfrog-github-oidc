name: Build and Push Image1

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create Buildx builder
        run: docker buildx create --use

      - name: Build Docker image using BuildKit and export tar
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t myapp:latest \
            --output type=docker,dest=./image.tar .

      - name: Upload image tar as artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-image
          path: image.tar

  push_image:
    runs-on: ubuntu-latest
    needs: build_image
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: built-image
          path: .

      - name: Load Docker image from tar
        id: load_image
        run: |
          docker load --input image.tar
          echo "image_name=myapp:latest" >> $GITHUB_OUTPUT

      - name: Print loaded image name
        run: |
          IMAGE_NAME="${{ steps.load_image.outputs.image_name }}"
          echo "Loaded image: $IMAGE_NAME"

      - name: Tag and Push to JFrog
        run: |
          SOURCE_IMAGE="${{ steps.load_image.outputs.image_name }}"
          TARGET_REPO="hts2-girigithub-oci-local.jfrog.io/ociimage"
          PRIMARY_TAG="$TARGET_REPO:v1.2.3-linux-amd64"

          docker tag "$SOURCE_IMAGE" "$PRIMARY_TAG"
          docker push "$PRIMARY_TAG"

          for tag in latest stable; do
            docker tag "$SOURCE_IMAGE" "$TARGET_REPO:$tag-linux-amd64"
            docker push "$TARGET_REPO:$tag-linux-amd64"
          done
