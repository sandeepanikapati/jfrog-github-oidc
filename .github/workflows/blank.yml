name: Build and Push Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create Buildx builder
        run: docker buildx create --use

      - name: Build Docker image using BuildKit and export tar
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --provenance=false \
            --sbom=false \
            -t myapp:latest \
            --output type=docker,dest=./image.tar .

      - name: Upload image tar as artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-image
          path: image.tar

  push_image:
    runs-on: ubuntu-latest
    needs: build_image
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: built-image
          path: .

      - name: Log in to JFrog Docker registry
        run: |
          docker login ${{ secrets.JF_DOCKER_URL }} \
            -u ${{ secrets.JFROG_USERNAME }} \
            --password ${{ secrets.JFROG_PASSWORD }}

      - name: Load Docker image from tar
        id: load_image
        run: |
          docker load --input image.tar
          echo "image_name=myapp:latest" >> $GITHUB_OUTPUT

      - name: Tag & Push canonical tag
        id: push_canonical
        run: |
          SOURCE_IMAGE="${{ steps.load_image.outputs.image_name }}"
          TARGET_REPO="hts2-girigithub-oci-local.jfrog.io/myapp"
          CANONICAL_TAG="$TARGET_REPO:v1.2.3-linux-amd64"

          echo "Pushing canonical tag: $CANONICAL_TAG"
          docker tag "$SOURCE_IMAGE" "$CANONICAL_TAG"
          docker push "$CANONICAL_TAG"

          # Extract digest
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$CANONICAL_TAG" | cut -d'@' -f2)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

      - name: Create additional tags pointing to SAME digest (latest, stable)
        run: |
          TARGET_REPO="hts2-girigithub-oci-local.jfrog.io/myapp"
          DIGEST="${{ steps.push_canonical.outputs.digest }}"

          echo "Using manifest digest: $DIGEST"

          for tag in latest-linux-amd64 stable-linux-amd64; do
            echo "Creating tag: $tag -> $DIGEST"

            curl -X PUT \
              -u "${{ secrets.JFROG_USERNAME }}:${{ secrets.JFROG_PASSWORD }}" \
              -H "Content-Type: application/vnd.oci.image.manifest.v1+json" \
              --data-binary @<(curl -s -u "${{ secrets.JFROG_USERNAME }}:${{ secrets.JFROG_PASSWORD }}" \
                "https://${{ secrets.JF_DOCKER_URL }}/v2/myapp/manifests/${DIGEST}") \
              "https://${{ secrets.JF_DOCKER_URL }}/v2/myapp/manifests/${tag}"
          done
