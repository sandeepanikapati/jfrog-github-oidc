name: Build and Push Image

on:
  workflow_dispatch:

jobs:
  build_image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Buildx builder
        run: |
          docker buildx create --use

      - name: Build Docker image using BuildKit and export tar
        run: |
          docker buildx build \
            --platform linux/amd64 \
            -t myapp:latest \
            --output type=docker,dest=./image.tar .

      - name: Upload image tar as artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-image
          path: image.tar

  push_image:
    runs-on: ubuntu-latest
    needs: build_image
    steps:
      - name: Download image tar
        uses: actions/download-artifact@v4
        with:
          name: built-image
          path: .

      - name: Load Docker image from tar
        id: load_image
        run: |
          loaded_output=$(docker load --input image.tar)
          echo "$loaded_output"

          IMAGE_NAME=$(echo "$loaded_output" | grep -oP '(?<=Loaded image: ).*')

          echo "Detected image name: $IMAGE_NAME"
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Print loaded image name
        run: echo "Loaded image:" ${{ steps.load_image.outputs.image_name }}

      - name: Tag and Push to JFrog
        run: |
          SOURCE_IMAGE="${{ steps.load_image.outputs.image_name }}"
          TARGET_REPO="hts2-girigithub-oci-local.jfrog.io/ociimage"
          PRIMARY_TAG="$TARGET_REPO:v1.2.3-linux-amd64"

          echo "Tagging primary image: $PRIMARY_TAG"
          docker tag "$SOURCE_IMAGE" "$PRIMARY_TAG"
          docker push "$PRIMARY_TAG"

          for tag in latest stable; do
            NEW_TAG="$TARGET_REPO:$tag-linux-amd64"
            echo "Tagging and pushing $NEW_TAG"
            docker tag "$SOURCE_IMAGE" "$NEW_TAG"
            docker push "$NEW_TAG"
          done
